---
title: scDesign Scalability Study
params:
    config: 1
---

```{r}
library(reticulate)
library(SingleCellExperiment)
library(scDesign3)
use_python("/usr/bin/python3")
scipy_sparse <- import("scipy.sparse")
configurations <- read.csv("data/scalability_configurations.csv")
attach(params)
n_cell <- configurations$n_cell[config]
n_gene <- configurations$n_gene[config, ]
replicate <- configurations$replicate[config, ]
set.seed(config)
```

```{r}
X <- scipy_sparse$load_npz("data/million_cells/X.npz")
cell_names <- paste0("cell_", seq_len(n_cell))
gene_names <- paste0("gene_", seq_len(n_gene))
cell_ix <- sample(seq_len(nrow(X)), n_cell)
gene_ix <- sample(seq_len(ncol(X)), n_gene)

obs <- read.csv("data/million_cells/obs.csv")[cell_ix, ]
var_ <- read.csv("data/million_cells/var.csv")[gene_ix, ]
X <- X[cell_ix, gene_ix]
rownames(obs) <- cell_names
rownames(var_) <- gene_names
dimnames(X) <- list(cell_names, gene_names)

dataset <- SingleCellExperiment(
    assays = list(X = t(X)),
    rowData = var_,
    colData = obs
)
```

```{r}
start <- Sys.time()
example_simu <- scdesign3(
    sce = dataset,
    assay_use = "X",
    celltype = "cell_type",
    pseudotime = NULL,
    spatial = NULL,
    other_covariates = "CoVID.19.severity",
    mu_formula = "cell_type + CoVID.19.severity",
    sigma_formula = "cell_type",
    family_use = "nb",
    n_cores = 2,
    usebam = FALSE,
    corr_formula = "1",
    copula = "gaussian",
    DT = TRUE,
    pseudo_obs = FALSE,
    return_model = FALSE,
    nonzerovar = FALSE
)
timing <- Sys.time() - start
```

```{r}
data.frame(
    n_gene = n_gene,
    n_cell = n_cell,
    replicate = replicate,
    seconds = as.numeric(timing)
) |>
    write.csv(paste0("scdesign3_timing_", config, ".csv"))
```

The block below shows how the configurations were defined.

```{r, eval = FALSE}
configurations <- expand.grid(
    n_cell = seq(500, 5e6, length.out = 5),
    n_gene = c(500, 2e4, length.out = 5),
    replicate = seq_len(5)
) |>
    data.frame()

write.csv(configurations, "scalability_configurations.csv", row.names = FALSE)
```